<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Darayi - Personal Vault</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%233b82f6'/%3E%3Cstop offset='100%25' stop-color='%231d4ed8'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M16 2 L28 7 L28 15 C28 22.5 22.5 28 16 30 C9.5 28 4 22.5 4 15 L4 7 Z' fill='url(%23bg)'/%3E%3Crect x='12' y='15' width='8' height='7' rx='1.5' fill='rgba(255,255,255,0.9)'/%3E%3Cpath d='M13.5 15 L13.5 12 C13.5 10 14.5 9 16 9 C17.5 9 18.5 10 18.5 12 L18.5 15' fill='none' stroke='rgba(255,255,255,0.9)' stroke-width='1.8' stroke-linecap='round'/%3E%3Ccircle cx='16' cy='18' r='1.2' fill='%231d4ed8'/%3E%3Crect x='15.5' y='18.5' width='1' height='2' rx='0.5' fill='%231d4ed8'/%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    body { background-color: #0a0a0f; color: #e4e4e7; }
  </style>
</head>
<body class="min-h-screen antialiased">
  <header class="border-b border-zinc-800 px-6 py-4">
    <div class="flex items-center justify-between">
      <h1 class="text-xl font-bold tracking-tight text-zinc-100">Darayi</h1>
      <div class="flex items-center gap-3">
        <nav class="flex gap-1" id="tab-nav"></nav>
        <button onclick="toggleSyncModal()" id="sync-btn" class="relative rounded-lg p-2 text-zinc-500 hover:bg-zinc-800 hover:text-zinc-300 transition-colors" title="Backup & Sync">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <span id="sync-dot" class="absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-violet-500 hidden"></span>
        </button>
      </div>
    </div>
  </header>

  <!-- Sync Modal Overlay -->
  <div id="sync-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleSyncModal()"></div>
    <div class="fixed top-16 right-4 w-full max-w-md z-50">
      <div id="sync-modal-content" class="rounded-xl border border-zinc-700 bg-zinc-900 p-5 shadow-2xl"></div>
    </div>
  </div>

  <main class="mx-auto max-w-4xl px-4 py-8" id="app"></main>

  <script>
    // --- Data Layer (localStorage) ---
    function load(key) {
      try { return JSON.parse(localStorage.getItem('darayi_' + key)) || []; }
      catch { return []; }
    }
    function save(key, data) {
      localStorage.setItem('darayi_' + key, JSON.stringify(data));
    }
    function genId() { return Date.now() + Math.random().toString(36).slice(2, 8); }

    let currentTab = localStorage.getItem('darayi_tab') || 'vault';
    let cash = load('cash');
    let gold = load('gold');
    let bitcoin = load('bitcoin');
    let loans = load('loans');
    let salary = load('salary');
    let expenses = load('expenses');
    let goldPrice = null;
    let goldPriceUpdatedAt = null;
    let btcPrice = null;
    let btcPriceUpdatedAt = null;
    let syncPasscode = localStorage.getItem('darayi_sync_passcode') || '';
    let syncCode = localStorage.getItem('darayi_sync_code') || '';
    let syncModalOpen = false;
    let syncStatus = '';
    const currencies = {
      USD: { symbol: '$', prefix: true, decimals: 2 },
      IQD: { symbol: 'IQD', prefix: false, decimals: 0 },
    };
    let salaryCurrency = localStorage.getItem('darayi_salary_currency') || 'IQD';
    let customUsdIqd = localStorage.getItem('darayi_custom_usd_iqd') ? parseFloat(localStorage.getItem('darayi_custom_usd_iqd')) : null;
    let usdIqdRate = customUsdIqd || null; // live rate, updated on init

    // --- Gold Price (CoinGecko Tether Gold tracks gold price, CORS-friendly) ---
    async function fetchGoldPrice() {
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether-gold&vs_currencies=usd');
        if (!res.ok) throw new Error();
        const data = await res.json();
        const pricePerOunce = data['tether-gold']?.usd;
        if (!pricePerOunce) throw new Error();
        goldPrice = pricePerOunce / 31.1035;
        goldPriceUpdatedAt = new Date().toLocaleTimeString();
      } catch {}
      render();
    }

    // --- Bitcoin Price ---
    async function fetchBtcPrice() {
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
        if (!res.ok) throw new Error();
        const data = await res.json();
        const price = data.bitcoin?.usd;
        if (!price) throw new Error();
        btcPrice = price;
        btcPriceUpdatedAt = new Date().toLocaleTimeString();
      } catch {}
      render();
    }

    // --- Helpers ---
    function fmt(n) {
      return n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Amounts are ALWAYS stored in IQD. fmtS converts for display only.
    function fmtS(n) {
      let displayAmount = n;
      const rate = customUsdIqd || usdIqdRate;
      if (salaryCurrency === 'USD' && rate) {
        displayAmount = n / rate;
      }
      const c = currencies[salaryCurrency] || currencies.IQD;
      const val = displayAmount.toLocaleString('en-US', { minimumFractionDigits: c.decimals, maximumFractionDigits: c.decimals });
      return c.prefix ? c.symbol + val : val + ' ' + c.symbol;
    }

    // Convert user input to IQD for storage
    function toIqd(amount) {
      if (salaryCurrency === 'USD') {
        const rate = customUsdIqd || usdIqdRate;
        return rate ? amount * rate : amount;
      }
      return amount;
    }

    function setSalaryCurrency(code) {
      salaryCurrency = code;
      localStorage.setItem('darayi_salary_currency', code);
      render();
    }

    async function fetchUsdIqdRate() {
      if (customUsdIqd) { usdIqdRate = customUsdIqd; return; }
      try {
        const res = await fetch('https://open.er-api.com/v6/latest/USD');
        if (!res.ok) throw new Error();
        const data = await res.json();
        const rate = data.rates?.IQD;
        if (rate) usdIqdRate = rate;
      } catch {}
      render();
    }

    function setCustomRate() {
      const val = parseFloat(document.getElementById('custom-rate-input').value);
      if (!val || isNaN(val) || val <= 0) return;
      customUsdIqd = val;
      usdIqdRate = val;
      localStorage.setItem('darayi_custom_usd_iqd', val);
      render();
    }

    function clearCustomRate() {
      customUsdIqd = null;
      localStorage.removeItem('darayi_custom_usd_iqd');
      fetchUsdIqdRate();
    }

    function totalCash() { return cash.reduce((s, e) => s + e.amount, 0); }
    function totalGrams() { return gold.reduce((s, e) => s + e.grams, 0); }
    function totalGoldValue() { return goldPrice ? totalGrams() * goldPrice : 0; }
    function totalBtc() { return bitcoin.reduce((s, e) => s + e.btc, 0); }
    function totalBtcValue() { return btcPrice ? totalBtc() * btcPrice : 0; }
    function totalLoans() { return loans.filter(l => !l.is_returned).reduce((s, e) => s + e.amount, 0); }
    function totalIncome() { return salary.reduce((s, e) => s + e.amount, 0); }
    function totalExpenses() { return expenses.reduce((s, e) => s + e.amount, 0); }
    function switchTab(tab) { currentTab = tab; localStorage.setItem('darayi_tab', tab); render(); }

    // --- Render ---
    function render() {
      // Tab navigation
      document.getElementById('tab-nav').innerHTML = `
        <button onclick="switchTab('vault')"
          class="rounded-lg px-4 py-1.5 text-sm font-medium ${currentTab === 'vault' ? 'bg-emerald-600 text-white' : 'text-zinc-400 hover:text-zinc-200'}">Vault</button>
        <button onclick="switchTab('salary')"
          class="rounded-lg px-4 py-1.5 text-sm font-medium ${currentTab === 'salary' ? 'bg-rose-600 text-white' : 'text-zinc-400 hover:text-zinc-200'}">Salary</button>
      `;

      if (currentTab === 'vault') renderVault();
      else renderSalary();

      // Update sync modal content if open
      if (syncModalOpen) renderSync();

      // Update sync dot indicator
      const dot = document.getElementById('sync-dot');
      if (dot) dot.classList.toggle('hidden', !!syncPasscode);
    }

    function renderVault() {
      const tc = totalCash();
      const tgv = totalGoldValue();
      const tbv = totalBtcValue();
      const tl = totalLoans();
      const total = tc + tgv + tbv + tl;
      const tg = totalGrams();
      const tb = totalBtc();

      const outstandingLoans = loans.filter(l => !l.is_returned);
      const returnedLoans = loans.filter(l => l.is_returned);

      document.getElementById('app').innerHTML = `
        <!-- Vault Summary -->
        <div class="mb-8 rounded-xl border border-zinc-800 bg-zinc-900/50 p-6">
          <h2 class="mb-4 text-sm font-medium uppercase tracking-wider text-zinc-500">Vault Total</h2>
          <p class="mb-6 text-4xl font-bold text-emerald-400">$${fmt(total)}</p>
          <div class="grid grid-cols-2 gap-4 sm:grid-cols-4">
            <div class="rounded-lg bg-zinc-800/50 p-3">
              <p class="text-xs text-zinc-500">Cash</p>
              <p class="text-lg font-semibold text-zinc-200">$${fmt(tc)}</p>
            </div>
            <div class="rounded-lg bg-zinc-800/50 p-3">
              <p class="text-xs text-zinc-500">Gold (${tg.toFixed(1)}g)</p>
              <p class="text-lg font-semibold text-amber-400">$${fmt(tgv)}</p>
              ${goldPrice ? `<p class="text-xs text-zinc-600">$${goldPrice.toFixed(2)}/g</p>` : ''}
            </div>
            <div class="rounded-lg bg-zinc-800/50 p-3">
              <p class="text-xs text-zinc-500">Bitcoin (${tb.toFixed(8)} BTC)</p>
              <p class="text-lg font-semibold text-orange-400">$${fmt(tbv)}</p>
              ${btcPrice ? `<p class="text-xs text-zinc-600">$${btcPrice.toLocaleString()}/BTC</p>` : ''}
            </div>
            <div class="rounded-lg bg-zinc-800/50 p-3">
              <p class="text-xs text-zinc-500">Lent Out</p>
              <p class="text-lg font-semibold text-blue-400">$${fmt(tl)}</p>
            </div>
          </div>
        </div>

        <div class="grid gap-6 md:grid-cols-2">
          <!-- Cash Section -->
          <div class="rounded-xl border border-zinc-800 bg-zinc-900/50 p-5">
            <h3 class="mb-4 text-sm font-medium uppercase tracking-wider text-zinc-500">Cash</h3>
            <form onsubmit="addCash(event)" class="mb-4 flex gap-2">
              <input type="number" step="0.01" placeholder="Amount" id="cash-amount"
                class="w-28 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-emerald-500 focus:outline-none" />
              <input type="text" placeholder="Note (optional)" id="cash-note"
                class="flex-1 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-emerald-500 focus:outline-none" />
              <button type="submit"
                class="rounded-lg bg-emerald-600 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-700">Add</button>
            </form>
            ${cash.length === 0 ? '<p class="text-sm text-zinc-600">No cash entries yet.</p>' :
              `<ul class="space-y-2">${cash.map(e => `
                <li class="flex items-center justify-between rounded-lg bg-zinc-800/50 px-3 py-2">
                  <div>
                    <span class="font-medium text-zinc-200">$${fmt(e.amount)}</span>
                    ${e.note ? `<span class="ml-2 text-sm text-zinc-500">${esc(e.note)}</span>` : ''}
                  </div>
                  <button onclick="removeCash('${e.id}')" class="text-xs text-zinc-600 hover:text-red-400">Remove</button>
                </li>`).join('')}</ul>`}
          </div>

          <!-- Gold Section -->
          <div class="rounded-xl border border-zinc-800 bg-zinc-900/50 p-5">
            <div class="mb-4 flex items-center justify-between">
              <h3 class="text-sm font-medium uppercase tracking-wider text-zinc-500">Gold</h3>
              ${goldPrice ? `
                <div class="text-right">
                  <span class="text-sm font-medium text-amber-400">$${goldPrice.toFixed(2)}/g</span>
                  <p class="text-xs text-zinc-600">Updated ${goldPriceUpdatedAt}</p>
                </div>` : `
                <span class="text-xs text-zinc-600">Loading price...</span>`}
            </div>
            <form onsubmit="addGold(event)" class="mb-4 flex gap-2">
              <input type="number" step="0.01" placeholder="Grams" id="gold-grams"
                class="w-28 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-amber-500 focus:outline-none" />
              <input type="text" placeholder="Note (optional)" id="gold-note"
                class="flex-1 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-amber-500 focus:outline-none" />
              <button type="submit"
                class="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700">Add</button>
            </form>
            ${gold.length === 0 ? '<p class="text-sm text-zinc-600">No gold entries yet.</p>' :
              `<ul class="space-y-2">${gold.map(e => `
                <li class="flex items-center justify-between rounded-lg bg-zinc-800/50 px-3 py-2">
                  <div>
                    <span class="font-medium text-amber-400">${e.grams}g</span>
                    ${goldPrice ? `<span class="ml-2 text-sm text-zinc-400">≈ $${fmt(e.grams * goldPrice)}</span>` : ''}
                    ${e.note ? `<span class="ml-2 text-sm text-zinc-500">${esc(e.note)}</span>` : ''}
                  </div>
                  <button onclick="removeGold('${e.id}')" class="text-xs text-zinc-600 hover:text-red-400">Remove</button>
                </li>`).join('')}</ul>`}
          </div>
        </div>

        <!-- Bitcoin Section -->
        <div class="mt-6 rounded-xl border border-zinc-800 bg-zinc-900/50 p-5">
          <div class="mb-4 flex items-center justify-between">
            <h3 class="text-sm font-medium uppercase tracking-wider text-zinc-500">Bitcoin</h3>
            ${btcPrice ? `
              <div class="text-right">
                <span class="text-sm font-medium text-orange-400">$${btcPrice.toLocaleString()}/BTC</span>
                <p class="text-xs text-zinc-600">Updated ${btcPriceUpdatedAt}</p>
              </div>` : `
              <span class="text-xs text-zinc-600">Loading price...</span>`}
          </div>
          <form onsubmit="addBtc(event)" class="mb-4 flex gap-2">
            <input type="number" step="0.00000001" placeholder="BTC amount" id="btc-amount"
              class="w-36 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-orange-500 focus:outline-none" />
            <input type="text" placeholder="Note (optional)" id="btc-note"
              class="flex-1 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-orange-500 focus:outline-none" />
            <button type="submit"
              class="rounded-lg bg-orange-600 px-4 py-2 text-sm font-medium text-white hover:bg-orange-700">Add</button>
          </form>
          ${bitcoin.length === 0 ? '<p class="text-sm text-zinc-600">No bitcoin entries yet.</p>' :
            `<ul class="space-y-2">${bitcoin.map(e => `
              <li class="flex items-center justify-between rounded-lg bg-zinc-800/50 px-3 py-2">
                <div>
                  <span class="font-medium text-orange-400">${e.btc} BTC</span>
                  ${btcPrice ? `<span class="ml-2 text-sm text-zinc-400">≈ $${fmt(e.btc * btcPrice)}</span>` : ''}
                  ${e.note ? `<span class="ml-2 text-sm text-zinc-500">${esc(e.note)}</span>` : ''}
                </div>
                <button onclick="removeBtc('${e.id}')" class="text-xs text-zinc-600 hover:text-red-400">Remove</button>
              </li>`).join('')}</ul>`}
        </div>

        <!-- Loans Section -->
        <div class="mt-6 rounded-xl border border-zinc-800 bg-zinc-900/50 p-5">
          <h3 class="mb-4 text-sm font-medium uppercase tracking-wider text-zinc-500">Money Lent Out</h3>
          <form onsubmit="addLoan(event)" class="mb-4 flex gap-2">
            <input type="text" placeholder="Borrower name" id="loan-name"
              class="flex-1 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-blue-500 focus:outline-none" />
            <input type="number" step="0.01" placeholder="Amount" id="loan-amount"
              class="w-28 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-blue-500 focus:outline-none" />
            <button type="submit"
              class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">Add</button>
          </form>
          ${outstandingLoans.length === 0 && returnedLoans.length === 0
            ? '<p class="text-sm text-zinc-600">No loans recorded.</p>'
            : `
              ${outstandingLoans.length > 0 ? `<ul class="mb-3 space-y-2">${outstandingLoans.map(e => `
                <li class="flex items-center justify-between rounded-lg bg-zinc-800/50 px-3 py-2">
                  <div class="flex items-center gap-3">
                    <button onclick="toggleLoan('${e.id}')"
                      class="h-4 w-4 rounded border border-zinc-600 hover:border-blue-400" title="Mark as returned"></button>
                    <div>
                      <span class="font-medium text-zinc-200">${esc(e.borrower_name)}</span>
                      <span class="ml-2 text-blue-400">$${fmt(e.amount)}</span>
                    </div>
                  </div>
                  <button onclick="removeLoan('${e.id}')" class="text-xs text-zinc-600 hover:text-red-400">Remove</button>
                </li>`).join('')}</ul>` : ''}
              ${returnedLoans.length > 0 ? `
                <p class="mb-2 text-xs text-zinc-600">Returned</p>
                <ul class="space-y-2 opacity-50">${returnedLoans.map(e => `
                  <li class="flex items-center justify-between rounded-lg bg-zinc-800/50 px-3 py-2">
                    <div class="flex items-center gap-3">
                      <button onclick="toggleLoan('${e.id}')"
                        class="flex h-4 w-4 items-center justify-center rounded border border-blue-500 bg-blue-500/20 text-xs text-blue-400"
                        title="Mark as outstanding">&#10003;</button>
                      <div>
                        <span class="font-medium text-zinc-400 line-through">${esc(e.borrower_name)}</span>
                        <span class="ml-2 text-zinc-500 line-through">$${fmt(e.amount)}</span>
                      </div>
                    </div>
                    <button onclick="removeLoan('${e.id}')" class="text-xs text-zinc-600 hover:text-red-400">Remove</button>
                  </li>`).join('')}</ul>` : ''}
            `}
        </div>

      `;
    }

    function renderSalary() {
      const ti = totalIncome();
      const te = totalExpenses();
      const remaining = ti - te;

      document.getElementById('app').innerHTML = `
        <!-- Salary Summary -->
        <div class="mb-8 rounded-xl border border-zinc-800 bg-zinc-900/50 p-6">
          <div class="mb-4 flex items-center justify-between">
            <h2 class="text-sm font-medium uppercase tracking-wider text-zinc-500">Salary Overview</h2>
            <select onchange="setSalaryCurrency(this.value)"
              class="rounded-lg border border-zinc-700 bg-zinc-800 px-2 py-1 text-xs text-zinc-300 focus:outline-none">
              ${Object.keys(currencies).map(c => `<option value="${c}" ${c === salaryCurrency ? 'selected' : ''}>${c}</option>`).join('')}
            </select>
          </div>
          <p class="mb-6 text-4xl font-bold ${remaining >= 0 ? 'text-rose-400' : 'text-red-500'}">${fmtS(remaining)}</p>
          <div class="grid grid-cols-3 gap-4">
            <div class="rounded-lg bg-zinc-800/50 p-3">
              <p class="text-xs text-zinc-500">Income</p>
              <p class="text-lg font-semibold text-emerald-400">${fmtS(ti)}</p>
            </div>
            <div class="rounded-lg bg-zinc-800/50 p-3">
              <p class="text-xs text-zinc-500">Spent</p>
              <p class="text-lg font-semibold text-rose-400">${fmtS(te)}</p>
            </div>
            <div class="rounded-lg bg-zinc-800/50 p-3">
              <p class="text-xs text-zinc-500">Remaining</p>
              <p class="text-lg font-semibold ${remaining >= 0 ? 'text-zinc-200' : 'text-red-500'}">${fmtS(remaining)}</p>
            </div>
          </div>
          <div class="mt-4 flex items-center gap-2 text-xs">
            <span class="text-zinc-600">1 USD =</span>
            <input type="number" step="1" placeholder="${customUsdIqd || 'API rate'}" id="custom-rate-input"
              value="${customUsdIqd || ''}"
              class="w-24 rounded border border-zinc-700 bg-zinc-800 px-2 py-1 text-xs text-zinc-300 placeholder-zinc-600 focus:border-rose-500 focus:outline-none" />
            <span class="text-zinc-600">IQD</span>
            <button onclick="setCustomRate()" class="rounded px-2 py-1 text-rose-400 border border-rose-400/30 hover:bg-rose-400/10">Set</button>
            ${customUsdIqd ? `<button onclick="clearCustomRate()" class="text-zinc-600 hover:text-red-400">Reset to API</button>` : `<span class="text-zinc-700">Using API rate</span>`}
          </div>
        </div>

        <div class="grid gap-6 md:grid-cols-2">
          <!-- Income Section -->
          <div class="rounded-xl border border-zinc-800 bg-zinc-900/50 p-5">
            <h3 class="mb-4 text-sm font-medium uppercase tracking-wider text-zinc-500">Income</h3>
            <form onsubmit="addSalary(event)" class="mb-4 flex gap-2">
              <input type="number" step="0.01" placeholder="Amount" id="salary-amount"
                class="w-28 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-emerald-500 focus:outline-none" />
              <input type="text" placeholder="Note (optional)" id="salary-note"
                class="flex-1 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-emerald-500 focus:outline-none" />
              <button type="submit"
                class="rounded-lg bg-emerald-600 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-700">Add</button>
            </form>
            ${salary.length === 0 ? '<p class="text-sm text-zinc-600">No income entries yet.</p>' :
              `<ul class="space-y-2">${salary.map(e => `
                <li class="flex items-center justify-between rounded-lg bg-zinc-800/50 px-3 py-2">
                  <div>
                    <span class="font-medium text-emerald-400">${fmtS(e.amount)}</span>
                    ${e.note ? `<span class="ml-2 text-sm text-zinc-500">${esc(e.note)}</span>` : ''}
                  </div>
                  <button onclick="removeSalary('${e.id}')" class="text-xs text-zinc-600 hover:text-red-400">Remove</button>
                </li>`).join('')}</ul>`}
          </div>

          <!-- Expenses Section -->
          <div class="rounded-xl border border-zinc-800 bg-zinc-900/50 p-5">
            <h3 class="mb-4 text-sm font-medium uppercase tracking-wider text-zinc-500">Expenses</h3>
            <form onsubmit="addExpense(event)" class="mb-4 flex gap-2">
              <input type="number" step="0.01" placeholder="Amount" id="expense-amount"
                class="w-28 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-rose-500 focus:outline-none" />
              <input type="text" placeholder="Category" id="expense-category"
                class="w-28 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-rose-500 focus:outline-none" />
              <input type="text" placeholder="Note" id="expense-note"
                class="flex-1 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-rose-500 focus:outline-none" />
              <button type="submit"
                class="rounded-lg bg-rose-600 px-4 py-2 text-sm font-medium text-white hover:bg-rose-700">Add</button>
            </form>
            ${expenses.length === 0 ? '<p class="text-sm text-zinc-600">No expenses yet.</p>' :
              `<ul class="space-y-2">${expenses.map(e => `
                <li class="flex items-center justify-between rounded-lg bg-zinc-800/50 px-3 py-2">
                  <div>
                    <span class="font-medium text-rose-400">${fmtS(e.amount)}</span>
                    ${e.category ? `<span class="ml-2 rounded bg-zinc-700 px-1.5 py-0.5 text-xs text-zinc-300">${esc(e.category)}</span>` : ''}
                    ${e.note ? `<span class="ml-2 text-sm text-zinc-500">${esc(e.note)}</span>` : ''}
                  </div>
                  <button onclick="removeExpense('${e.id}')" class="text-xs text-zinc-600 hover:text-red-400">Remove</button>
                </li>`).join('')}</ul>`}
          </div>
        </div>

      `;
    }

    function toggleSyncModal() {
      syncModalOpen = !syncModalOpen;
      const modal = document.getElementById('sync-modal');
      if (syncModalOpen) {
        modal.classList.remove('hidden');
        renderSync();
      } else {
        modal.classList.add('hidden');
      }
    }

    function renderSync() {
      const el = document.getElementById('sync-modal-content');
      if (!el) return;

      // Update the sync dot indicator in the header
      const dot = document.getElementById('sync-dot');
      if (dot) dot.classList.toggle('hidden', !!syncPasscode);

      el.innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-sm font-semibold uppercase tracking-wider text-zinc-400">Backup & Sync</h3>
          <button onclick="toggleSyncModal()" class="text-zinc-500 hover:text-zinc-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          ${!syncPasscode ? `
            <div>
              <p class="mb-2 text-xs text-zinc-500">Set a sync passcode to enable encrypted backups</p>
              <div class="flex gap-2">
                <input type="password" placeholder="Choose a passcode" id="set-passcode"
                  class="flex-1 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-violet-500 focus:outline-none" />
                <button onclick="setSyncPasscode()"
                  class="rounded-lg bg-violet-600 px-4 py-2 text-sm font-medium text-white hover:bg-violet-700">Save</button>
              </div>
            </div>
          ` : `
            <div>
              <div class="mb-2 flex items-center justify-between">
                <p class="text-xs text-zinc-500">Sync code — auto-updated on every change</p>
                <button onclick="clearSyncPasscode()" class="text-xs text-zinc-600 hover:text-red-400">Change passcode</button>
              </div>
              <textarea id="sync-output" readonly rows="3"
                class="w-full rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-xs text-zinc-300 focus:outline-none">${esc(syncCode)}</textarea>
              <button onclick="navigator.clipboard.writeText(document.getElementById('sync-output').value).then(() => { this.textContent = 'Copied!'; setTimeout(() => { this.textContent = 'Copy to clipboard'; }, 2000); })"
                class="mt-1 text-xs text-violet-400 hover:text-violet-300">Copy to clipboard</button>
            </div>
          `}
          <hr class="border-zinc-800" />
          <div>
            <p class="mb-2 text-xs text-zinc-500">Import — paste a sync code from another device</p>
            <textarea id="import-data" rows="3"
              class="w-full rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-xs text-zinc-300 placeholder-zinc-600 focus:outline-none"
              placeholder="Paste sync code here..."></textarea>
            <div class="mt-2 flex gap-2">
              <input type="password" placeholder="Passcode" id="import-passcode"
                class="flex-1 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm text-zinc-200 placeholder-zinc-600 focus:border-violet-500 focus:outline-none" />
              <button onclick="importBackup()"
                class="rounded-lg bg-violet-600 px-4 py-2 text-sm font-medium text-white hover:bg-violet-700">Import</button>
            </div>
          </div>
          ${syncStatus ? `<p class="text-xs ${syncStatus.startsWith('Import failed') ? 'text-red-400' : 'text-emerald-400'}">${esc(syncStatus)}</p>` : ''}
          <hr class="border-zinc-800" />
          <div>
            <p class="mb-2 text-xs text-zinc-500">Local backup — save a file to your device</p>
            <div class="flex gap-2">
              <button onclick="downloadBackup()"
                class="flex-1 rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-xs text-zinc-300 hover:bg-zinc-700">Download backup</button>
              <label class="flex-1 cursor-pointer rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-2 text-xs text-zinc-300 hover:bg-zinc-700 text-center">
                Restore from file
                <input type="file" accept=".json" onchange="restoreBackup(event)" class="hidden" />
              </label>
            </div>
          </div>
        </div>
      `;
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    // --- Crypto (Web Crypto API: PBKDF2 + AES-GCM) ---
    async function deriveKey(passcode, salt) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(passcode), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['encrypt', 'decrypt']
      );
    }

    async function encryptData(jsonString, passcode) {
      const enc = new TextEncoder();
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(passcode, salt);
      const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(jsonString));
      const combined = new Uint8Array(salt.length + iv.length + new Uint8Array(encrypted).length);
      combined.set(salt, 0);
      combined.set(iv, salt.length);
      combined.set(new Uint8Array(encrypted), salt.length + iv.length);
      return btoa(String.fromCharCode(...combined));
    }

    async function decryptData(base64String, passcode) {
      const combined = Uint8Array.from(atob(base64String), c => c.charCodeAt(0));
      const salt = combined.slice(0, 16);
      const iv = combined.slice(16, 28);
      const data = combined.slice(28);
      const key = await deriveKey(passcode, salt);
      const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, data);
      return new TextDecoder().decode(decrypted);
    }

    // --- Actions ---
    function addCash(e) {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('cash-amount').value);
      const note = document.getElementById('cash-note').value.trim();
      if (!amount || isNaN(amount)) return;
      cash.unshift({ id: genId(), amount, note: note || null, created_at: new Date().toISOString() });
      save('cash', cash);
      render(); autoSync();
    }

    function removeCash(id) {
      cash = cash.filter(e => e.id !== id);
      save('cash', cash);
      render(); autoSync();
    }

    function addGold(e) {
      e.preventDefault();
      const grams = parseFloat(document.getElementById('gold-grams').value);
      const note = document.getElementById('gold-note').value.trim();
      if (!grams || isNaN(grams) || grams <= 0) return;
      gold.unshift({ id: genId(), grams, note: note || null, created_at: new Date().toISOString() });
      save('gold', gold);
      render(); autoSync();
    }

    function removeGold(id) {
      gold = gold.filter(e => e.id !== id);
      save('gold', gold);
      render(); autoSync();
    }

    function addBtc(e) {
      e.preventDefault();
      const btc = parseFloat(document.getElementById('btc-amount').value);
      const note = document.getElementById('btc-note').value.trim();
      if (!btc || isNaN(btc) || btc <= 0) return;
      bitcoin.unshift({ id: genId(), btc, note: note || null, created_at: new Date().toISOString() });
      save('bitcoin', bitcoin);
      render(); autoSync();
    }

    function removeBtc(id) {
      bitcoin = bitcoin.filter(e => e.id !== id);
      save('bitcoin', bitcoin);
      render(); autoSync();
    }

    function addLoan(e) {
      e.preventDefault();
      const name = document.getElementById('loan-name').value.trim();
      const amount = parseFloat(document.getElementById('loan-amount').value);
      if (!name || !amount || isNaN(amount)) return;
      loans.unshift({ id: genId(), borrower_name: name, amount, is_returned: false, created_at: new Date().toISOString() });
      save('loans', loans);
      render(); autoSync();
    }

    function toggleLoan(id) {
      const loan = loans.find(e => e.id === id);
      if (loan) loan.is_returned = !loan.is_returned;
      save('loans', loans);
      render(); autoSync();
    }

    function removeLoan(id) {
      loans = loans.filter(e => e.id !== id);
      save('loans', loans);
      render(); autoSync();
    }

    // --- Salary Actions ---
    function addSalary(e) {
      e.preventDefault();
      const raw = parseFloat(document.getElementById('salary-amount').value);
      const note = document.getElementById('salary-note').value.trim();
      if (!raw || isNaN(raw)) return;
      const amount = toIqd(raw);
      salary.unshift({ id: genId(), amount, note: note || null, created_at: new Date().toISOString() });
      save('salary', salary);
      render(); autoSync();
    }

    function removeSalary(id) {
      salary = salary.filter(e => e.id !== id);
      save('salary', salary);
      render(); autoSync();
    }

    function addExpense(e) {
      e.preventDefault();
      const raw = parseFloat(document.getElementById('expense-amount').value);
      const category = document.getElementById('expense-category').value.trim();
      const note = document.getElementById('expense-note').value.trim();
      if (!raw || isNaN(raw)) return;
      const amount = toIqd(raw);
      expenses.unshift({ id: genId(), amount, category: category || null, note: note || null, created_at: new Date().toISOString() });
      save('expenses', expenses);
      render(); autoSync();
    }

    function removeExpense(id) {
      expenses = expenses.filter(e => e.id !== id);
      save('expenses', expenses);
      render(); autoSync();
    }

    // --- Sync ---
    async function autoSync() {
      if (!syncPasscode) return;
      try {
        const data = JSON.stringify({ cash, gold, bitcoin, loans, salary, expenses });
        syncCode = await encryptData(data, syncPasscode);
        localStorage.setItem('darayi_sync_code', syncCode);
      } catch {}
    }

    function setSyncPasscode() {
      const val = document.getElementById('set-passcode').value.trim();
      if (!val) return;
      syncPasscode = val;
      localStorage.setItem('darayi_sync_passcode', val);
      autoSync().then(() => render());
    }

    function clearSyncPasscode() {
      syncPasscode = '';
      syncCode = '';
      localStorage.removeItem('darayi_sync_passcode');
      localStorage.removeItem('darayi_sync_code');
      render();
    }

    async function importBackup() {
      const passcode = document.getElementById('import-passcode').value;
      const blob = document.getElementById('import-data').value.replace(/\s/g, '');
      if (!passcode || !blob) return;
      try {
        const jsonString = await decryptData(blob, passcode);
        const data = JSON.parse(jsonString);
        if (data.cash) { cash = data.cash; save('cash', cash); }
        if (data.gold) { gold = data.gold; save('gold', gold); }
        if (data.bitcoin) { bitcoin = data.bitcoin; save('bitcoin', bitcoin); }
        if (data.loans) { loans = data.loans; save('loans', loans); }
        if (data.salary) { salary = data.salary; save('salary', salary); }
        if (data.expenses) { expenses = data.expenses; save('expenses', expenses); }
        syncStatus = 'Data imported successfully!';
        await autoSync();
        render();
      } catch {
        syncStatus = 'Import failed — wrong passcode or invalid data.';
        render();
      }
    }

    // --- Local Backup ---
    function downloadBackup() {
      const data = JSON.stringify({ cash, gold, bitcoin, loans, salary, expenses, salaryCurrency, customUsdIqd }, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'darayi-backup-' + new Date().toISOString().slice(0, 10) + '.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function restoreBackup(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function () {
        try {
          const data = JSON.parse(reader.result);
          if (data.cash) { cash = data.cash; save('cash', cash); }
          if (data.gold) { gold = data.gold; save('gold', gold); }
          if (data.bitcoin) { bitcoin = data.bitcoin; save('bitcoin', bitcoin); }
          if (data.loans) { loans = data.loans; save('loans', loans); }
          if (data.salary) { salary = data.salary; save('salary', salary); }
          if (data.expenses) { expenses = data.expenses; save('expenses', expenses); }
          if (data.salaryCurrency) { salaryCurrency = data.salaryCurrency; localStorage.setItem('darayi_salary_currency', data.salaryCurrency); }
          if (data.customUsdIqd) { customUsdIqd = data.customUsdIqd; usdIqdRate = data.customUsdIqd; localStorage.setItem('darayi_custom_usd_iqd', data.customUsdIqd); }
          syncStatus = 'Restored from local backup!';
          autoSync();
          render();
        } catch {
          syncStatus = 'Restore failed — invalid file.';
          render();
        }
      };
      reader.readAsText(file);
    }

    // --- Init ---
    render();
    fetchGoldPrice();
    fetchBtcPrice();
    fetchUsdIqdRate();
  </script>
</body>
</html>
